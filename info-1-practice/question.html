<!DOCTYPE html>
<!-- ここから全ページ共通 -->
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>情報I 共通テスト100点への道 | おかだのページ</title>
    <link rel="icon" href="../img/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../main.css">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/f01ea68b5a.js" crossorigin="anonymous"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@100;300;400;500;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SBE12XNHB2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-SBE12XNHB2');
    </script>

    <!-- 共通部分ここまで -->
    <link rel="stylesheet" type="text/css" href="j1-practice.css">
</head>

<body>
    <div class="content">
        <div id="header">
        </div>
        <main>
            <form id="quiz-form">
                <div id="quiz-container"></div>
                <button type="submit">提出</button>
            </form>
            <div id="result"></div>
        </main>
    </div>

    <!-- 共通JS -->
    <script src="../main.js"></script>

    <!-- 問題データ（questions 変数を定義） -->
    <script src="./question-list.js"></script>

    <!-- ロジック本体 -->
    <script>
        let blankCounter = 1;
        const allAnswers = [];
        const urlParams = new URLSearchParams(window.location.search);
        const num = urlParams.get('num');
        const level = urlParams.get('level');

        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';

            questions[level][num - 1].question.forEach((q, qIndex) => {
                let html = q.text;
                const inputRegex = /(___|\_\_t\_\_|\_\_n\_\_)/g;

                q.answers.forEach((_, aIndex) => {
                    const id = `blank${blankCounter}`;

                    // 対象となる穴埋めタイプを検出
                    const match = inputRegex.exec(html);
                    if (!match) return;

                    let inputType = 'text';
                    if (match[0] === '__n__') inputType = 'number';

                    const inputHTML = `<input type="${inputType}" id="${id}" name="${id}" class="blank-input" placeholder="__${blankCounter}__">`;

                    // 最初の一致箇所だけ置換
                    html = html.replace(match[0], inputHTML);

                    allAnswers.push({
                        id,
                        correct: q.answers[aIndex],
                        explanation: q.explanations[aIndex],
                        type: inputType,
                    });

                    blankCounter++;
                });

                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `${html}`;
                container.appendChild(questionDiv);
            });
        }

        document.getElementById("quiz-form").addEventListener("submit", function (e) {
            e.preventDefault();
            let dialog = "";
            let correctCount = 0;

            allAnswers.forEach((obj, i) => {
                const inputEl = document.getElementById(obj.id);
                const userInput = inputEl.value.trim();
                const isCorrect = userInput === obj.correct;
                inputEl.style.borderColor = isCorrect ? "green" : "red";

                dialog += `【__${i + 1}__】あなたの答え: ${userInput}\n`;
                dialog += isCorrect ? "⭕ 正解！\n" : `❌ 不正解。正解は「${obj.correct}」です。\n`;
                dialog += `解説：${obj.explanation}\n\n`;

                if (isCorrect) correctCount++;
            });

            dialog = `正解数: ${correctCount} / ${allAnswers.length}\n\n` + dialog;
            alert(dialog);

            // ★ここに Google Sheets 送信機能を追加できます
        });

        renderQuiz();
    </script>
</body>

</html>